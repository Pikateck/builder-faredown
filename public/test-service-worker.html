<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Service Worker Admin API Test</title>
    <style>
      body {
        font-family:
          system-ui,
          -apple-system,
          sans-serif;
        max-width: 800px;
        margin: 40px auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .test-box {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      button {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        margin: 10px 10px 10px 0;
      }
      button:hover {
        background: #2563eb;
      }
      button:disabled {
        background: #9ca3af;
        cursor: not-allowed;
      }
      .success {
        color: #059669;
        font-weight: 600;
      }
      .error {
        color: #dc2626;
        font-weight: 600;
      }
      .info {
        color: #0284c7;
      }
      pre {
        background: #f3f4f6;
        padding: 12px;
        border-radius: 4px;
        overflow-x: auto;
        font-size: 14px;
      }
      .status {
        padding: 8px 12px;
        border-radius: 4px;
        margin: 8px 0;
        font-weight: 500;
      }
      .status.ok {
        background: #d1fae5;
        color: #059669;
      }
      .status.fail {
        background: #fee2e2;
        color: #dc2626;
      }
      .status.pending {
        background: #fef3c7;
        color: #d97706;
      }
    </style>
  </head>
  <body>
    <h1>üî¨ Service Worker Admin API Test</h1>
    <p class="info">
      Service Worker intercepts admin API calls at a low level, bypassing
      FullStory completely
    </p>

    <div class="test-box">
      <h2>Step 1: Register Service Worker</h2>
      <button id="register-btn" onclick="registerWorker()">
        üìã Register Service Worker
      </button>
      <div id="register-status"></div>
    </div>

    <div class="test-box">
      <h2>Step 2: Test Admin API</h2>
      <button id="test-btn" onclick="testAdminAPI()" disabled>
        üß™ Test Admin API
      </button>
      <div id="test-results"></div>
    </div>

    <div class="test-box">
      <h2>Console Logs</h2>
      <pre id="console-logs"></pre>
    </div>

    <script>
      let logs = [];
      let workerReady = false;

      function addLog(message, type = "info") {
        const timestamp = new Date().toISOString().split("T")[1].split(".")[0];
        logs.push(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
        document.getElementById("console-logs").textContent = logs.join("\n");
      }

      async function registerWorker() {
        const statusDiv = document.getElementById("register-status");
        statusDiv.innerHTML =
          '<div class="status pending">‚è≥ Registering service worker...</div>';
        addLog("Starting service worker registration", "info");

        try {
          if (!("serviceWorker" in navigator)) {
            throw new Error("Service Worker not supported in this browser");
          }

          // Unregister any existing workers
          const registrations =
            await navigator.serviceWorker.getRegistrations();
          for (const registration of registrations) {
            if (registration.active?.scriptURL.includes("admin-fetch-worker")) {
              await registration.unregister();
              addLog("Unregistered old worker", "info");
            }
          }

          // Register new worker
          const registration = await navigator.serviceWorker.register(
            "/admin-fetch-worker.js",
            {
              scope: "/",
            },
          );

          addLog(
            `Service Worker registered with scope: ${registration.scope}`,
            "success",
          );

          // Wait for worker to be ready
          await navigator.serviceWorker.ready;
          addLog("Service Worker is ready!", "success");

          workerReady = true;
          document.getElementById("test-btn").disabled = false;

          statusDiv.innerHTML = `
                    <div class="status ok">‚úÖ SERVICE WORKER ACTIVE</div>
                    <p class="success">Admin API calls will now bypass FullStory!</p>
                    <p class="info">Scope: ${registration.scope}</p>
                `;
        } catch (error) {
          addLog(
            `Service Worker registration failed: ${error.message}`,
            "error",
          );
          statusDiv.innerHTML = `
                    <div class="status fail">‚ùå REGISTRATION FAILED</div>
                    <p class="error">${error.message}</p>
                `;
        }
      }

      async function testAdminAPI() {
        const resultsDiv = document.getElementById("test-results");
        resultsDiv.innerHTML =
          '<p class="info">Testing admin API through service worker...</p>';
        logs = [];

        try {
          if (!workerReady) {
            throw new Error("Service Worker not ready. Register it first.");
          }

          addLog("Making admin API request", "info");
          addLog(
            "Service Worker will intercept and handle this request",
            "info",
          );

          // Make a regular fetch - service worker will intercept it
          const response = await fetch(
            "/admin/users?limit=1&_test=" + Date.now(),
            {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
                Accept: "application/json",
              },
              credentials: "include",
            },
          );

          addLog(`Response status: ${response.status}`, "info");
          addLog(
            `Response headers: ${JSON.stringify(Object.fromEntries(response.headers.entries()))}`,
            "info",
          );

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP ${response.status}: ${errorText}`);
          }

          const data = await response.json();
          addLog("Admin API request successful!", "success");

          resultsDiv.innerHTML = `
                    <div class="status ok">‚úÖ SERVICE WORKER SUCCESS</div>
                    <p class="success">Admin API accessible through Service Worker (FullStory bypassed)</p>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
        } catch (error) {
          addLog(`Admin API test error: ${error.message}`, "error");
          resultsDiv.innerHTML = `
                    <div class="status fail">‚ùå TEST FAILED</div>
                    <p class="error">${error.message}</p>
                    <p class="info">Check console logs above for details</p>
                `;
        }
      }

      // Auto-register on load
      window.addEventListener("load", () => {
        addLog("Page loaded, waiting for user action", "info");
      });
    </script>
  </body>
</html>
